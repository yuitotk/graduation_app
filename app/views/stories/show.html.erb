<p><%= link_to "ストーリー一覧へ", stories_path %></p>

<p>
  <%= link_to "ストーリー編集", edit_story_path(@story) %>
</p>

<h1><%= @story.title %></h1>

<hr>

<h2>詳細メモ</h2>

<% if @story.description.present? %>
  <div>
    <%= simple_format(@story.description) %>
  </div>
<% else %>
  <p>なし</p>
<% end %>

<p>
  <%= link_to "新規作成", new_idea_path(return_to: request.fullpath, placeable_type: "Story", placeable_id: @story.id) %> |
  <%= link_to "AI作成", random_words_pick_path(return_to: request.fullpath, placeable_type: "Story", placeable_id: @story.id) %>
</p>

<hr>

<p><%= link_to "要素を管理する", story_story_elements_path(@story) %></p>

<p><%= link_to "整合性チェック（登場イベント）", consistency_story_path(@story) %></p>

<hr>

<%# ✅ 追加：アイデアのマーカー（複数）表示用 %>
<% marker_labels_for = lambda do |idea| %>
  <% placement = idea.idea_placement %>
  <% next "" if placement.blank? %>

  <% labels = [] %>
  <% if placement.story_elements.present? %>
    <% placement.story_elements.each do |el| %>
      <% labels << [el.marker.presence, el.name.presence, el.kind.presence].compact.join(" ") %>
    <% end %>
  <% end %>

  <% labels.reject(&:blank?).join(" / ") %>
<% end %>

<h3>新規アイデア</h3>

<% if @created_here_ideas.present? %>
  <ul>
    <% @created_here_ideas.each do |idea| %>
      <% markers = marker_labels_for.call(idea) %>
      <li>
        <%= link_to idea.title, idea_path(idea) %>
        <% if markers.present? %>
          <div style="font-size: 0.9em; opacity: 0.85;">
            <strong>マーカー：</strong><%= markers %>
          </div>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>まだありません</p>
<% end %>

<hr>

<h3>ここに移動したアイデア</h3>

<% if @moved_ideas.present? %>
  <ul>
    <% @moved_ideas.each do |idea| %>
      <% markers = marker_labels_for.call(idea) %>
      <li>
        <%= link_to idea.title, idea_path(idea) %>
        <% if markers.present? %>
          <div style="font-size: 0.9em; opacity: 0.85;">
            <strong>マーカー：</strong><%= markers %>
          </div>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>まだありません</p>
<% end %>

<hr>

<h2>イベント（時系列）</h2>

<p><%= link_to "イベント追加", new_story_story_event_path(@story) %></p>

<ul>
  <% @story_events.each do |event| %>
    <li>
      <strong><%= link_to event.title, story_story_event_path(@story, event) %></strong><br>
      <%= simple_format(truncate(event.body.to_s, length: 120)) %>

      <%= button_to "↑", move_up_story_story_event_path(@story, event),
            method: :patch, form: { style: "display:inline" } %>
      <%= button_to "↓", move_down_story_story_event_path(@story, event),
            method: :patch, form: { style: "display:inline" } %>
    </li>
  <% end %>
</ul>
